{{ $apiKey := os.Getenv "HUGO_STEAM_API" }}
{{ $steamID := os.Getenv "HUGO_STEAM_ID" }}

{{ if and $apiKey $steamID }}
  {{ $oneYearAgoUnix := sub now.Unix 31536000 }}

  <!-- Fetch owned games with last played timestamps -->
  {{ $ownedGamesURL := printf "https://api.steampowered.com/IPlayerService/GetOwnedGames/v1/?steamid=%s&key=%s&include_appinfo=1&include_played_free_games=1&format=json" $steamID $apiKey }}
  {{ $ownedGamesResponse := resources.GetRemote $ownedGamesURL }}

  {{ if $ownedGamesResponse.Err }}
    <p>Error fetching games: {{ $ownedGamesResponse.Err }}</p>
  {{ else }}
    {{ $ownedGames := $ownedGamesResponse.Content | unmarshal }}

    {{ if $ownedGames.response.games }}
      <!-- Filter games played in last year -->
      {{ $recentGames := slice }}
      {{ range $ownedGames.response.games }}
        {{ if ge .rtime_last_played $oneYearAgoUnix }}
          {{ $recentGames = $recentGames | append . }}
        {{ end }}
      {{ end }}

      <!-- Sort by last played time (descending) -->
      {{ $sortedGames := sort $recentGames "rtime_last_played" "desc" }}

      <!-- Return data for template consumption -->
      {{ return dict "recentGames" $sortedGames "error" nil }}
    {{ end }}
  {{ end }}
{{ else }}
  <p>Steam API key or Steam ID not configured</p>
{{ end }}

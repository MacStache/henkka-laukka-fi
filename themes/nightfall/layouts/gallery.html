{{ define "main" }}
  <div class="gallery-header">
    <h1>NYT LUEN</h1>
  </div>

  {{ $reading := where .Site.Data.books "status" "reading" }}
  {{ if gt (len $reading) 0 }}
    <div class="gallery-section">
      <div class="gallery">
        {{ range $reading }}
          <div class="book-item">
            <p class="book-author">{{ .firstName }} {{ .lastName }}</p>
            <img src="{{ .image }}" alt="{{ .title }}" />
            <p class="book-title">{{ .title }}</p>
            {{ if .startDate }}
              {{ $parts := split .startDate "-" }}
              <p class="book-date">Alkanut: {{ index $parts 2 }}.{{ index $parts 1 }}.{{ index $parts 0 }}</p>
            {{ end }}
          </div>
        {{ end }}
      </div>
    </div>
  {{ end }}

  <div class="gallery-header">
    <h1>LUETUT</h1>
    <div class="sort-controls">
      <a href="#" class="sort-btn sort-date active" data-sort="date">Lajittele päivämäärän mukaan</a>
      <a href="#" class="sort-btn sort-author" data-sort="author">Lajittele kirjailijan mukaan</a>
    </div>
  </div>

  {{ $finished := where .Site.Data.books "status" "finished" }}
  {{ if gt (len $finished) 0 }}
    <div class="gallery-section">
      <div class="gallery" id="finished-books">

        <div class="instruction-with-badge">
          <div class="instruction-badge-demo">
            <div class="book-review-badge">✎</div>
          </div>
          <p>Klikkaa kuvaketta nähdäksesi<br>
          kirjasta kirjoitetun lyhkärin</p>
        </div>
        {{ $currentYear := "" }}
        {{ range (sort $finished "finishDate" "desc") }}
          {{ $finishParts := split .finishDate "-" }}
          {{ $year := index $finishParts 0 }}

          {{ if and .finishDate (ne $currentYear $year) }}
            {{ if ne $currentYear "" }}
              </div>
            {{ end }}

            <div class="year-separator">
              <div class="year-line"></div>
              <div class="year-label">{{ $year }}</div>
              <div class="year-line"></div>
            </div>

            <div class="books-year-group">

            {{ $currentYear = $year }}
          {{ end }}

          <div class="book-item" data-last-name="{{ .lastName }}" data-first-name="{{ .firstName }}" data-finish-date="{{ .finishDate }}">
            <p class="book-author">{{ .firstName }} {{ .lastName }}</p>
            <div class="book-image-wrapper">
              <img src="{{ .image }}" alt="{{ .title }}" />
              {{ if .reviewUrl }}
                <a href="{{ .reviewUrl }}" class="book-review-badge" title="Lyhkäri">✎</a>
              {{ end }}
            </div>
            <p class="book-title">{{ .title }}</p>
            {{ if .finishDate }}
              {{ $parts := split .finishDate "-" }}
              <p class="book-date">Luettu: {{ index $parts 2 }}.{{ index $parts 1 }}.{{ index $parts 0 }}</p>
            {{ end }}
          </div>
        {{ end }}

        {{ if ne $currentYear "" }}
          </div>
        {{ end }}
      </div>
    </div>
  {{ end }}

  <script>
    const sortBtns = document.querySelectorAll('.sort-btn');
    const finishedBooksContainer = document.getElementById('finished-books');

    sortBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const sortType = btn.dataset.sort;

        sortBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const books = Array.from(finishedBooksContainer.querySelectorAll('.book-item'));
        const separators = Array.from(finishedBooksContainer.querySelectorAll('.year-separator, .author-separator'));
        const yearGroups = Array.from(finishedBooksContainer.querySelectorAll('.books-year-group, .books-author-group'));

        // Remove all separators and year groups
        separators.forEach(sep => sep.remove());
        yearGroups.forEach(group => group.remove());

        if (sortType === 'date') {
          // Sort by date and recreate year separators
          books.sort((a, b) => {
            const dateA = new Date(b.dataset.finishDate);
            const dateB = new Date(a.dataset.finishDate);
            return dateA - dateB;
          });

          let currentYear = '';
          let yearGroup = null;

          books.forEach(book => {
            const bookYear = book.dataset.finishDate.substring(0, 4);

            if (bookYear !== currentYear) {
              // Create year separator
              const separator = document.createElement('div');
              separator.className = 'year-separator';
              separator.innerHTML = `
                <div class="year-line"></div>
                <div class="year-label">${bookYear}</div>
                <div class="year-line"></div>
              `;
              finishedBooksContainer.appendChild(separator);

              // Create year group
              yearGroup = document.createElement('div');
              yearGroup.className = 'books-year-group';
              finishedBooksContainer.appendChild(yearGroup);

              currentYear = bookYear;
            }

            yearGroup.appendChild(book);
          });
        } else if (sortType === 'author') {
          // Sort by author name and recreate letter separators
          books.sort((a, b) => {
            const lastNameA = a.dataset.lastName.toLowerCase();
            const lastNameB = b.dataset.lastName.toLowerCase();
            const firstNameA = a.dataset.firstName.toLowerCase();
            const firstNameB = b.dataset.firstName.toLowerCase();

            if (lastNameA !== lastNameB) {
              return lastNameA.localeCompare(lastNameB);
            }
            return firstNameA.localeCompare(firstNameB);
          });

          let currentLetter = '';
          let letterGroup = null;

          books.forEach(book => {
            const bookLetter = book.dataset.lastName.charAt(0).toUpperCase();

            if (bookLetter !== currentLetter) {
              // Create letter separator
              const separator = document.createElement('div');
              separator.className = 'author-separator';
              separator.innerHTML = `
                <div class="author-line"></div>
                <div class="author-label">${bookLetter}</div>
                <div class="author-line"></div>
              `;
              finishedBooksContainer.appendChild(separator);

              // Create letter group
              letterGroup = document.createElement('div');
              letterGroup.className = 'books-author-group';
              finishedBooksContainer.appendChild(letterGroup);

              currentLetter = bookLetter;
            }

            letterGroup.appendChild(book);
          });
        }
      });
    });
  </script>
{{ end }}

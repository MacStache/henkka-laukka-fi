{{ define "main" }}
  {{ $apiKey := os.Getenv "HUGO_STEAM_API" }}
  {{ $steamID := os.Getenv "HUGO_STEAM_ID" }}

  {{ if and $apiKey $steamID }}
    {{ $oneYearAgoUnix := sub now.Unix 31536000 }}
    {{ $ownedGamesURL := printf "https://api.steampowered.com/IPlayerService/GetOwnedGames/v1/?steamid=%s&key=%s&include_appinfo=1&include_played_free_games=1&format=json" $steamID $apiKey }}

    {{ $ownedGamesResponse := resources.GetRemote $ownedGamesURL }}

    {{ if $ownedGamesResponse }}
      {{ $ownedGames := $ownedGamesResponse | unmarshal }}

      {{ if $ownedGames.response.games }}
        {{ $recentGames := slice }}
        {{ range $ownedGames.response.games }}
          {{ if ge .rtime_last_played $oneYearAgoUnix }}
            {{ $recentGames = $recentGames | append . }}
          {{ end }}
        {{ end }}

        {{ $sortedGames := sort $recentGames "rtime_last_played" "desc" }}
        {{ $currentlyPlaying := first 2 $sortedGames }}

        <!-- Currently Playing Section -->
        {{ if gt (len $currentlyPlaying) 0 }}
          <div class="games-gallery-header">
            <h1>NYT PELAAN</h1>
          </div>
          <div class="games-gallery-section">
            <div class="games-gallery">
              {{ range $currentlyPlaying }}
                <div class="game-item" data-appid="{{ int .appid }}" data-game-name="{{ .name }}" data-playtime="{{ .playtime_forever }}">
                  <p class="game-name">{{ .name }}</p>
                  {{ if .appid }}
                    {{ if eq (int .appid) 2947440 }}
                      {{ $storeURL := printf "https://store.steampowered.com/api/appdetails?appids=%d&json=1" (int .appid) }}
                      {{ $storeData := resources.GetRemote $storeURL }}
                      {{ if $storeData }}
                        {{ $storeInfo := $storeData | unmarshal }}
                        {{ range $storeInfo }}
                          {{ if .success }}
                            <img src="{{ .data.header_image }}" alt="{{ .data.name }}" />
                          {{ else }}
                            <img src="https://steamcdn-a.akamaihd.net/steam/apps/{{ int $.appid }}/logo.png" alt="{{ $.name }}" />
                          {{ end }}
                        {{ end }}
                      {{ end }}
                    {{ else }}
                      <img src="https://steamcdn-a.akamaihd.net/steam/apps/{{ int .appid }}/header.jpg" alt="{{ .name }}" />
                    {{ end }}
                  {{ end }}
                  <p class="game-playtime">
                    {{ math.Ceil (div .playtime_forever 60) }} tuntia
                  </p>
                </div>
              {{ end }}
            </div>
          </div>
        {{ end }}

        <!-- All Games from Last Year (excluding top 2) -->
        {{ $remainingGames := after 2 $sortedGames }}
        {{ if gt (len $remainingGames) 0 }}
          <div class="games-gallery-header">
            <h1>PELATUT</h1>
          </div>
          <div class="games-gallery-section">
            <div class="games-gallery" id="steam-games">
              {{ range $remainingGames }}
                <div class="game-item" data-appid="{{ int .appid }}" data-game-name="{{ .name }}" data-playtime="{{ .playtime_forever }}" data-last-played="{{ .rtime_last_played }}">
                  <p class="game-name">{{ .name }}</p>
                  {{ if .appid }}
                    {{ if eq (int .appid) 2947440 }}
                      {{ $storeURL := printf "https://store.steampowered.com/api/appdetails?appids=%d&json=1" (int .appid) }}
                      {{ $storeData := resources.GetRemote $storeURL }}
                      {{ if $storeData }}
                        {{ $storeInfo := $storeData | unmarshal }}
                        {{ range $storeInfo }}
                          {{ if .success }}
                            <img src="{{ .data.header_image }}" alt="{{ .data.name }}" />
                          {{ else }}
                            <img src="https://steamcdn-a.akamaihd.net/steam/apps/{{ int $.appid }}/logo.png" alt="{{ $.name }}" />
                          {{ end }}
                        {{ end }}
                      {{ end }}
                    {{ else }}
                      <img src="https://steamcdn-a.akamaihd.net/steam/apps/{{ int .appid }}/header.jpg" alt="{{ .name }}" />
                    {{ end }}
                  {{ end }}
                  <p class="game-playtime">
                    {{ math.Ceil (div .playtime_forever 60) }} tuntia
                  </p>
                </div>
              {{ end }}
            </div>
          </div>
        {{ end }}
      {{ end }}
    {{ else }}
      <p>Error fetching games from Steam API</p>
    {{ end }}
  {{ else }}
    <p>Steam API key or Steam ID not configured</p>
  {{ end }}

  <!-- Modal -->
  <div id="game-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modal-title">Game Info</h2>
      <div id="modal-body">
        <p>Loading...</p>
      </div>
    </div>
  </div>

  <script>
    const modal = document.getElementById('game-modal');
    const closeBtn = document.querySelector('.close');
    const steamId = '{{ os.Getenv "HUGO_STEAM_ID" }}';

    closeBtn.onclick = function() {
      modal.style.display = 'none';
    }

    window.onclick = function(event) {
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    }

    document.querySelectorAll('.game-item').forEach(item => {
      item.style.cursor = 'pointer';
      item.addEventListener('click', function() {
        const appid = parseInt(this.dataset.appid);
        const gameName = this.dataset.gameName;
        const playtime = parseInt(this.dataset.playtime);
        const playtimeHours = Math.ceil(playtime / 60);

        document.getElementById('modal-title').textContent = gameName;

        let html = `<div class="stats-container">
          <div class="stats-summary">
            <p><strong>Total Playtime:</strong> ${playtimeHours} hours</p>
            <p><strong>App ID:</strong> ${appid}</p>
            <p><a href="https://steamcommunity.com/profiles/${steamId}/stats/${appid}" target="_blank" style="color: #0366d6;">View Stats on Steam Community â†’</a></p>
          </div>
          <p style="color: #aaa; font-size: 0.9rem; margin-top: 15px;">Not all games have publicly available stats. Click the link above to view achievements and detailed statistics on Steam.</p>
        </div>`;

        document.getElementById('modal-body').innerHTML = html;
        modal.style.display = 'block';
      });
    });
  </script>
{{ end }}
